<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="home.css">
    <title>Home - Kosmikos</title>
</head>

<body>
    <header>
        <nav>
            <div class="logo">
                <img src="logo.png" alt="Kosmikos">
                <span>Kosmikos</span>
            </div>
            <ul>
                <li><a href="/about-us">About Us</a></li>
                <li><a href="/profile">Profile</a></li>
                <li><a href="/logout">Logout</a></li>
            </ul>
        </nav>
        <h1>Your Kosmos</h1>
        <p>See what your friends are up to!</p>
    </header>
    
    <main>
        <section class="post-options">
            <button class="post-btn" onclick="toggleForm('text-form')">Text</button>
            <button class="post-btn" onclick="toggleForm('image-form')">Image</button>
            <button class="post-btn" onclick="toggleForm('video-form')">Video</button>
            <button class="post-btn" onclick="toggleForm('audio-form')">Audio</button>
            <button class="post-btn" onclick="toggleForm('link-form')">Link</button>
        </section>

        <!-- Post Forms -->
        <section class="post-forms">
            <form id="text-form" class="post-form hidden">
                <h3>Create a Text Post</h3>
                <textarea id="text-content" placeholder="Write something..."></textarea>
                <button type="button" onclick="submitPost('text')">Post</button>
            </form>

            <form id="image-form" class="post-form hidden">
                <h3>Upload an Image</h3>
                <input type="file" id="image-content" accept="image/*">
                <button type="button" onclick="submitPost('image')">Post</button>
            </form>

            <form id="video-form" class="post-form hidden">
                <h3>Upload a Video</h3>
                <input type="file" id="video-content" accept="video/*">
                <button type="button" onclick="submitPost('video')">Post</button>
            </form>

            <form id="audio-form" class="post-form hidden">
                <h3>Upload an Audio File</h3>
                <input type="file" id="audio-content" accept="audio/*">
                <button type="button" onclick="submitPost('audio')">Post</button>
            </form>

            <form id="link-form" class="post-form hidden">
                <h3>Share a Link</h3>
                <input type="url" id="link-content" placeholder="Enter URL">
                <button type="button" onclick="submitPost('link')">Post</button>
            </form>
        </section>

        <!-- Feed -->
        <section class="search-bar">
            <input type="text" id="search-input" placeholder="Search users...">
            <div class="search-results" id="search-results"></div>
        </section>
        
        <section class="feed">
            <h2>Posts from People You Might Know</h2>
            <div id="posts-feed"></div>
        </section>
    </main>

    <script>
        function toggleForm(formId) {
            document.querySelectorAll('.post-form').forEach(form => {
                form.classList.add('hidden');
            });
            document.getElementById(formId).classList.toggle('hidden');
        }

        async function fetchPosts() {
            console.log("Fetching posts...");

            try {
                const response = await fetch("/posts");
                const posts = await response.json();

                console.log("Fetched posts:", posts);

                const feed = document.getElementById("posts-feed");
                feed.innerHTML = "";

                if (!posts.length) {
                    feed.innerHTML = "<p>No posts to show.</p>";
                    return;
                }

                posts.forEach(post => {
                    const postElement = document.createElement("div");
                    postElement.classList.add("post");

                    // Create post header with username
                    const postHeader = document.createElement("div");
                    postHeader.classList.add("post-header");

                    const username = document.createElement("h3");
                    username.textContent = post.username;

                    postHeader.appendChild(username);
                    postElement.appendChild(postHeader);

                    // Add post content based on type
                    if (post.type === "text") {
                        postElement.innerHTML += `<p>${post.content}</p>`;
                    } else if (post.type === "image") {
                        postElement.innerHTML += `<img src="${post.content}" alt="Image" style="max-width:100%;">`;
                    } else if (post.type === "video") {
                        postElement.innerHTML += `<video controls style="max-width:100%;"><source src="${post.content}" type="video/mp4"></video>`;
                    } else if (post.type === "audio") {
                        postElement.innerHTML += `<audio controls><source src="${post.content}" type="audio/mpeg"></audio>`;
                    } else if (post.type === "link") {
                        postElement.innerHTML += `<a href="${post.content}" target="_blank">${post.content}</a>`;
                    }

                    feed.appendChild(postElement);
                });

            } catch (error) {
                console.error("Error fetching posts:", error);
            }
        }

        async function submitPost(type) {
            let content;

            // Handle text and link posts
            if (type === "text") {
                content = document.getElementById(`${type}-content`).value.trim();

                if (!content) {
                    alert(`${type.charAt(0).toUpperCase() + type.slice(1)} content cannot be empty!`);
                    return;
                }

                const response = await fetch(`/post/${type}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    document.getElementById(`${type}-content`).value = ""; // Clear input
                    fetchPosts(); // Refresh the feed
                } else {
                    const errorData = await response.json();
                    alert("Error: " + errorData.error);
                }

                return;
            }

            if (type === "link") {
                content = document.getElementById("link-content").value.trim();

                if (!content) {
                    alert("Link content cannot be empty!");
                    return;
                }

                // Validate URL format before posting
                if (!isValidURL(content)) {
                    alert("Please enter a valid URL.");
                    return;
                }

                try {
                    console.log(`Posting link: ${content}`); // Debugging log

                    const response = await fetch("/post/link", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ content })
                    });

                    const responseData = await response.json();
                    console.log("Server Response:", responseData); // Debugging log

                    if (response.ok) {
                        document.getElementById("link-content").value = ""; // Clear input field
                        fetchPosts(); // Refresh feed
                    } else {
                        alert("Error: " + (responseData.error || "Something went wrong!"));
                    }
                } catch (error) {
                    console.error("Network Error:", error);
                    alert("Failed to post. Please check your connection.");
                }

                return;
            }

            // Handle image, video, and audio posts
            let formData = new FormData();
            const fileInput = document.getElementById(`${type}-content`);
            
            if (!fileInput.files.length) {
                alert(`Please select a ${type} file to upload.`);
                return;
            }

            formData.append("file", fileInput.files[0]);

            const response = await fetch(`/post/${type}`, {
                method: "POST",
                body: formData,
            });

            if (response.ok) {
                fetchPosts();
            } else {
                alert("Error uploading file.");
            }

        }

        document.getElementById("search-input").addEventListener("input", async function () {
            const query = this.value.trim();
            const resultsContainer = document.getElementById("search-results");

            resultsContainer.innerHTML = ""; // Clear previous results

            if (query === "") {
                resultsContainer.classList.remove("active"); // Hide when empty
                return;
            }

            try {
                const response = await fetch(`/search/users?query=${query}`);
                const users = await response.json();

                if (users.length === 0) {
                    resultsContainer.classList.remove("active"); // Hide if no results
                    return;
                }

                users.forEach(user => {
                    const item = document.createElement("div");
                    item.classList.add("result-item");

                    item.innerHTML = `
                        <img src="${user.profile_picture || '/images/default-profile.jpg'}" alt="Profile">
                        <span>${user.f_name}</span>
                    `;

                    // Redirect to profile on click
                    item.addEventListener("click", () => {
                        window.location.href = `/profile/${user.id}`;
                    });

                    resultsContainer.appendChild(item);
                });

                resultsContainer.classList.add("active"); // Show results

            } catch (error) {
                console.error("Error fetching search results:", error);
            }
        });

        document.addEventListener("DOMContentLoaded", fetchPosts);
    </script>
</body>
</html>
