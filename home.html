<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="home.css">
    <title>Home - Kosmikos</title>
</head>

<body>
    <header>
        <nav>
            <div class="logo">
                <img src="logo.png" alt="Kosmikos">
                <span>Kosmikos</span>
            </div>
            <ul>
                <li><a href="/about-us">About Us</a></li>
                <li><a href="/profile">Profile</a></li>
                <li><a href="/logout">Logout</a></li>
            </ul>
        </nav>
        <h1>Your Kosmos</h1>
        <p>See what your friends are up to!</p>
    </header>
    
    <main>
        <section class="post-options">
            <button class="post-btn" onclick="toggleForm('text-form')">Text</button>
            <button class="post-btn" onclick="toggleForm('image-form')">Image</button>
            <button class="post-btn" onclick="toggleForm('video-form')">Video</button>
            <button class="post-btn" onclick="toggleForm('audio-form')">Audio</button>
            <button class="post-btn" onclick="toggleForm('link-form')">Link</button>
        </section>

        <!-- Post Forms -->
        <section class="post-forms">
            <form id="text-form" class="post-form hidden">
                <h3>Create a Text Post</h3>
                <textarea id="text-content" placeholder="Write something..."></textarea>
                <button type="button" onclick="submitPost('text')">Post</button>
            </form>

            <form id="image-form" class="post-form hidden">
                <h3>Upload an Image</h3>
                <input type="file" id="image-content" accept="image/*">
                <button type="button" onclick="submitPost('image')">Post</button>
            </form>

            <form id="video-form" class="post-form hidden">
                <h3>Upload a Video</h3>
                <input type="file" id="video-content" accept="video/*">
                <button type="button" onclick="submitPost('video')">Post</button>
            </form>

            <form id="audio-form" class="post-form hidden">
                <h3>Upload an Audio File</h3>
                <input type="file" id="audio-content" accept="audio/*">
                <button type="button" onclick="submitPost('audio')">Post</button>
            </form>

            <form id="link-form" class="post-form hidden">
                <h3>Share a Link</h3>
                <input type="url" id="link-content" placeholder="Enter URL">
                <button type="button" onclick="submitPost('link')">Post</button>
            </form>
        </section>

        <!-- Feed -->
        <section class="search-bar">
            <input type="text" id="search-input" placeholder="Search for posts or users...">
            <button id="search-btn">Search</button>
        </section>
        
        <section class="feed">
            <h2>Posts from People You Might Know</h2>
            <div id="posts-feed"></div>
        </section>
    </main>

    <script>
        function toggleForm(formId) {
            document.querySelectorAll('.post-form').forEach(form => {
                form.classList.add('hidden');
            });
            document.getElementById(formId).classList.toggle('hidden');
        }

        async function fetchPosts() {
            console.log("Fetching posts...");

            try {
                const response = await fetch("/posts");
                const posts = await response.json();

                console.log("Fetched posts:", posts);

                const feed = document.getElementById("posts-feed");
                feed.innerHTML = "";

                if (!posts.length) {
                    feed.innerHTML = "<p>No posts to show.</p>";
                    return;
                }

                posts.forEach(post => {
                    const postElement = document.createElement("div");
                    postElement.classList.add("post");

                    // Create post header with username, follow button, and follower count
                    const postHeader = document.createElement("div");
                    postHeader.classList.add("post-header");

                    const username = document.createElement("h3");
                    username.textContent = post.username;

                    const followButton = document.createElement("button");
                    followButton.classList.add("follow-btn");
                    followButton.textContent = post.isFollowing ? "Unfollow" : "Follow";
                    followButton.setAttribute("data-user-id", post.userId); // Ensure userId is correctly set

                    const followerCount = document.createElement("p");
                    followerCount.classList.add("follower-count");
                    followerCount.textContent = `Followers: ${post.followers || 0}`;

                    postHeader.appendChild(username);
                    postHeader.appendChild(followButton);
                    postHeader.appendChild(followerCount);
                    postElement.appendChild(postHeader);

                    // Add post content based on type
                    if (post.type === "text") {
                        postElement.innerHTML += `<p>${post.content}</p>`;
                    } else if (post.type === "image") {
                        postElement.innerHTML += `<img src="${post.content}" alt="Image" style="max-width:100%;">`;
                    } else if (post.type === "video") {
                        postElement.innerHTML += `<video controls style="max-width:100%;"><source src="${post.content}" type="video/mp4"></video>`;
                    } else if (post.type === "audio") {
                        postElement.innerHTML += `<audio controls><source src="${post.content}" type="audio/mpeg"></audio>`;
                    } else if (post.type === "link") {
                        postElement.innerHTML += `<a href="${post.content}" target="_blank">${post.content}</a>`;
                    }

                    feed.appendChild(postElement);
                });

                // Add event listeners to follow buttons
                document.querySelectorAll(".follow-btn").forEach(button => {
                    button.addEventListener("click", () => {
                        const userId = button.getAttribute("data-user-id"); // Extract userId from the button
                        if (!userId || isNaN(userId)) {
                            console.error("Invalid user ID:", userId);
                            return;
                        }
                        followUser(userId);
                    });
                });
            } catch (error) {
                console.error("Error fetching posts:", error);
            }
        }

        // Function to handle follow/unfollow
        async function followUser(userId) {
            console.log("Attempting to follow/unfollow user ID:", userId); // Debugging line

            const followButton = document.querySelector(`.follow-btn[data-user-id="${userId}"]`);
            if (!followButton) return;

            // Optimistic UI Update (change button instantly)
            const isFollowing = followButton.textContent === "Unfollow";
            followButton.textContent = isFollowing ? "Follow" : "Unfollow";
            followButton.classList.toggle("unfollow");

            try {
                const response = await fetch("/api/follow", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId: Number(userId) }),
                });

                const result = await response.json();

                if (!response.ok) {
                    alert(result.error || "Failed to follow/unfollow user");
                    // Revert the button state if the request fails
                    followButton.textContent = isFollowing ? "Unfollow" : "Follow";
                    followButton.classList.toggle("unfollow");
                    return;
                }

                // Update the follower count dynamically
                updateFollowerCount(userId);
            } catch (error) {
                console.error("Error:", error);
                alert("Something went wrong. Please try again.");
                // Revert button state if an error occurs
                followButton.textContent = isFollowing ? "Unfollow" : "Follow";
                followButton.classList.toggle("unfollow");
            }
        }

        // Function to update the follower count
        async function updateFollowerCount(userId) {
            try {
                const response = await fetch(`/api/followers/${userId}`);
                const data = await response.json();

                if (response.ok) {
                    const followerCountElement = document.querySelector(`.follower-count[data-user-id="${userId}"]`);
                    if (followerCountElement) {
                        followerCountElement.textContent = `Followers: ${data.followers}`;
                    }
                } else {
                    console.error("Failed to fetch follower count");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        async function submitPost(type) {
            let content;

            // Handle text and link posts
            if (type === "text" || type === "link") {
                content = document.getElementById(`${type}-content`).value.trim();

                if (!content) {
                    alert(`${type.charAt(0).toUpperCase() + type.slice(1)} content cannot be empty!`);
                    return;
                }

                const response = await fetch(`/post/${type}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    document.getElementById(`${type}-content`).value = ""; // Clear input
                    fetchPosts(); // Refresh the feed
                } else {
                    const errorData = await response.json();
                    alert("Error: " + errorData.error);
                }

                return;
            }

            // Handle image, video, and audio posts
            let formData = new FormData();
            const fileInput = document.getElementById(`${type}-content`);
            
            if (!fileInput.files.length) {
                alert(`Please select a ${type} file to upload.`);
                return;
            }

            formData.append("file", fileInput.files[0]);

            const response = await fetch(`/post/${type}`, {
                method: "POST",
                body: formData,
            });

            if (response.ok) {
                fetchPosts();
            } else {
                alert("Error uploading file.");
            }
        }

        document.addEventListener("DOMContentLoaded", fetchPosts);
    </script>
</body>
</html>